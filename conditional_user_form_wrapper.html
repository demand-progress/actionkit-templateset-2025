{% load actionkit_tags switchcase %}
<ul class="compact" id="ak-errors"></ul>

{% comment %}
This wrapper adds conditional logic to show extra fields for recognized users when needed.
For unrecognized users, it works the same as the standard user_form_wrapper.
{% endcomment %}
{% log_context %}
<div id="known_user">
    {% if not user.mobile_phone or not user.sms_opt_in == "Y" %}
        <div class="ak-recognized-user-extra-fields">
            <p>Hey <span id="known_user_name"></span>, we need a little more information:</p>
            
   
                {% with mobile_field=user_fields|filter:"field_name=mobile_phone"|first %}
                <div id="ak-fieldbox-mobile_phone" {% if "mobile_phone"|is_in:context.required %}class="required"{% endif %}>
                    <label for="id_mobile_phone">
                        {{ mobile_field.label_text }}{% if "mobile_phone"|is_in:context.required %}<span class="ak-required-flag">*</span>{% endif %}
                    </label>
                    {{ mobile_field.html_input }}
                </div>
            {% endwith %}
     
            
            {% if not user.sms_opt_in == "Y" %}
                {% with sms_field=user_fields|filter:"field_name=user_sms_opt_in"|first %}
                    <div id="ak-fieldbox-user_sms_opt_in" class="ak-checkbox-field {% if "user_sms_opt_in"|is_in:context.required %}required{% endif %}">
                        <label for="id_user_sms_opt_in">
                            {{ sms_field.label_text }}{% if "user_sms_opt_in"|is_in:context.required %}<span class="ak-required-flag">*</span>{% endif %}
                        </label>
                        {{ sms_field.html_input }}
                    </div>
                {% endwith %}
            {% endif %}
        </div>
        
    {% else %}
        Not <span id="known_user_name"></span>?  <a href="?" onclick="return actionkit.forms.logOut()">Click here.</a>
    {% endif %}
</div>

<div id="unknown_user" class="ak-user-form">
    {% include "./user_form.html" %}
</div>

<style>
.ak-recognized-user-extra-fields {
    background-color: #f9f9f9;
    border: 1px solid #e1e1e1;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 4px;
}

.ak-recognized-user-extra-fields p {
    margin-top: 0;
    font-weight: bold;
    margin-bottom: 15px;
}

.ak-checkbox-field {
    margin-top: 15px;
    padding: 10px;
    background-color: #f9f9f9;
    border: 1px solid #e1e1e1;
    border-radius: 4px;
}

.ak-checkbox-field label {
    display: inline;
    margin-left: 8px;
    font-weight: bold;
}

.disclaimer {
    margin-left: 24px;
    margin-top: 5px;
    font-size: 0.8em;
    color: #666;
    font-style: italic;
}
</style>
<script type="text/javascript">
// This script helps ensure the right fields are shown/hidden
// when a user is recognized or logs out
actionkit.forms.onContextLoaded = function(context) {
    // First, call the original onContextLoaded function
    // You might need to store a reference to it first
    var originalOnContextLoaded = actionkit.forms.onContextLoaded;
    
    // Log all context data
    console.log('Full ActionKit Context:', context);
    
    // Log specific user fields if they exist
    if (context.user) {
        console.log('User data:', context.user);
        console.log('User email:', context.user.email);
        console.log('User name:', context.user.first_name, context.user.last_name);
        console.log('User custom fields:', context.user.custom_fields);
    }
    
    // Log recognized user status
    if (context.recognized_user) {
        console.log('Recognized user:', context.recognized_user);
    }
    
    // Continue with original functionality
    if (originalOnContextLoaded && typeof originalOnContextLoaded === 'function') {
        originalOnContextLoaded.call(this, context);
    }
};
</script>